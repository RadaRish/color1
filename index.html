<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–π —Ç—É—Ä</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&subset=cyrillic&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="tour-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å—Ü–µ–Ω–∞–º–∏ -->
        <div id="scene-panel" class="open">
            <div class="scene-panel-header">
                <span class="title">–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–π —Ç—É—Ä</span>
                <button id="scene-panel-toggle" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω">‚ü®</button>
            </div>
            <div id="scene-list"></div>
        </div>

        <!-- A-Frame —Å—Ü–µ–Ω–∞ -->
        <a-scene 
            id="tour-scene"
            embedded
            style="height: 100vh; width: 100%;"
            background="color: #000000"
            vr-mode-ui="enabled: false"
            cursor="rayOrigin: mouse">
            
            <!-- –ê–∫—Ç–∏–≤—ã -->
            <a-assets>
                <img id="scene-0-–í—Ö–æ–¥-JPG-panorama" src="panoramas/scene-0-–í—Ö–æ–¥-JPG.jpg">
                <img id="scene-1-–ö—É—Ö–Ω—è-JPG-panorama" src="panoramas/scene-1-–ö—É—Ö–Ω—è-JPG.jpg">
            </a-assets>

            <!-- –ù–µ–±–µ—Å–Ω–∞—è —Å—Ñ–µ—Ä–∞ –¥–ª—è –ø–∞–Ω–æ—Ä–∞–º—ã -->
            <a-sky id="panorama-sky" src="#scene-0-–í—Ö–æ–¥-JPG-panorama" rotation="0 0 0"></a-sky>

            <!-- –ö–∞–º–µ—Ä–∞ —Å –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º -->
            <a-camera 
                id="tour-camera"
                look-controls="pointerLockEnabled: false"
                wasd-controls="enabled: false"
                position="0 1.6 0"
                fov="75"
                raycaster="objects: [data-raycastable]; far: 100; interval: 100">
            </a-camera>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤ -->
            <a-entity id="hotspots-container"></a-entity>
        </a-scene>

        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="tour-controls">
            <button id="fullscreen-btn">‚õ∂</button>
            <button id="zoom-in-btn">+</button>
            <button id="zoom-out-btn">‚àí</button>
            <button id="reset-view-btn">‚åÇ</button>
        </div>
    </div>

    <!-- –î–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞ -->
    <script src="tour-data.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
    <script>
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã A-Frame
        
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç billboard –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫ –∫–∞–º–µ—Ä–µ
        AFRAME.registerComponent('billboard', {
            tick: function () {
                const camera = document.querySelector('[camera]');
                if (camera) {
                    this.el.object3D.lookAt(camera.object3D.position);
                }
            }
        });

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π
        AFRAME.registerComponent('face-camera', {
            init: function () {
                this.cameraEl = null;
                this.tick = this.tick.bind(this);
                this.findCamera();
            },

            findCamera: function () {
                this.cameraEl = document.querySelector('[camera]') ||
                              document.querySelector('a-camera') ||
                              document.querySelector('#defaultCamera');

                if (!this.cameraEl) {
                    const scene = document.querySelector('a-scene');
                    if (scene && scene.camera && scene.camera.el) {
                        this.cameraEl = scene.camera.el;
                    }
                }
            },

            tick: function () {
                if (!this.cameraEl) {
                    this.findCamera();
                    return;
                }

                const cameraWorldPosition = new THREE.Vector3();
                const elementWorldPosition = new THREE.Vector3();

                this.cameraEl.object3D.getWorldPosition(cameraWorldPosition);
                this.el.object3D.getWorldPosition(elementWorldPosition);

                const direction = new THREE.Vector3();
                direction.subVectors(cameraWorldPosition, elementWorldPosition);
                direction.y = 0;
                direction.normalize();

                if (direction.length() > 0) {
                    const angle = Math.atan2(direction.x, direction.z) + Math.PI;
                    this.el.object3D.rotation.set(0, angle, 0);
                }
            }
        });

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        AFRAME.registerComponent('cyrillic-text', {
            schema: {
                value: { type: 'string', default: '' },
                color: { type: 'color', default: '#ffffff' },
                align: { type: 'string', default: 'center' },
                size: { type: 'number', default: 1.0 }
            },
            init: function() {
                this.createTextTexture();
            },
            update: function() {
                this.createTextTexture();
            },
            createTextTexture: function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const text = this.data.value;
                const size = this.data.size;
                
                canvas.width = 512;
                canvas.height = 128;
                
                ctx.fillStyle = 'rgba(0,0,0,0)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const fontSize = Math.round(32 * size);
                ctx.font = fontSize + 'px Roboto, Arial, sans-serif';
                ctx.fillStyle = this.data.color;
                ctx.textAlign = this.data.align;
                ctx.textBaseline = 'middle';
                
                const x = this.data.align === 'center' ? canvas.width / 2 : 
                         this.data.align === 'right' ? canvas.width - 10 : 10;
                ctx.fillText(text, x, canvas.height / 2);
                
                const texture = new THREE.CanvasTexture(canvas);
                texture.needsUpdate = true;
                
                const material = new THREE.MeshBasicMaterial({ 
                    map: texture, 
                    transparent: true,
                    alphaTest: 0.1
                });
                
                const geometry = new THREE.PlaneGeometry(2 * size, 0.5 * size);
                const mesh = new THREE.Mesh(geometry, material);
                
                this.el.setObject3D('mesh', mesh);
            }
        });

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
        AFRAME.registerComponent('hotspot-handler', {
            schema: {
                hotspotId: { type: 'string' },
                type: { type: 'string', default: 'info' },
                linkTo: { type: 'string' },
                title: { type: 'string' },
                description: { type: 'string' },
                videoUrl: { type: 'string' }
            },
            init: function() {
                this.el.addEventListener('click', this.onClick.bind(this));
                this.el.addEventListener('mouseenter', this.onMouseEnter.bind(this));
                this.el.addEventListener('mouseleave', this.onMouseLeave.bind(this));
                
                // –î–æ–±–∞–≤–ª—è–µ–º data-raycastable –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã raycaster
                this.el.setAttribute('data-raycastable', '');
            },
            onClick: function() {
                console.log('–ö–ª–∏–∫ –ø–æ —Ö–æ—Ç—Å–ø–æ—Ç—É:', this.data.hotspotId, '—Ç–∏–ø:', this.data.type, '–ø–µ—Ä–µ—Ö–æ–¥:', this.data.linkTo);
                // Info-point: –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –ù–ï –Ω–∞–≤–∏–≥–∏—Ä—É–µ–º
                if (this.data.type === 'info-point' || this.data.type === 'infopoint') {
                    this.showInfoModal();
                    return;
                }
                // –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å: –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ
                if (this.data.type === 'video-area') {
                    this.showVideoModal();
                    return;
                }
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥—Ä—É–≥–æ–π —Å—Ü–µ–Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
                if (this.data.linkTo && this.data.linkTo !== '' && this.data.linkTo !== 'undefined' && this.data.linkTo !== 'null') {
                    console.log('üîÑ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ü–µ–Ω–µ:', this.data.linkTo);
                    window.tourViewer.switchToScene(this.data.linkTo);
                    return;
                }
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∏–Ω—Ñ–æ
                this.showInfoModal();
            },
            showInfoModal: function() {
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤
                const removeFileExtension = (filename) => {
                    if (!filename || typeof filename !== 'string') {
                        return filename;
                    }
                    const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.flv', '.wmv', '.m4v', '.3gp', '.ogv'];
                    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.webp', '.tiff', '.ico'];
                    const allExtensions = [...videoExtensions, ...imageExtensions];
                    const lowerFilename = filename.toLowerCase();
                    for (const ext of allExtensions) {
                        if (lowerFilename.endsWith(ext)) {
                            return filename.slice(0, -ext.length);
                        }
                    }
                    return filename;
                };

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                const modal = document.createElement('div');
                modal.style.cssText = 
                    'position: fixed;' +
                    'top: 0;' +
                    'left: 0;' +
                    'width: 100%;' +
                    'height: 100%;' +
                    'background: rgba(0, 0, 0, 0.8);' +
                    'z-index: 10000;' +
                    'display: flex;' +
                    'align-items: center;' +
                    'justify-content: center;';
                
                const content = document.createElement('div');
                content.style.cssText = 
                    'background: #2a2a2a;' +
                    'padding: 30px;' +
                    'border-radius: 10px;' +
                    'max-width: 500px;' +
                    'color: white;' +
                    'font-family: Roboto, Arial, sans-serif;';
                
                content.innerHTML = 
                    '<h3 style="margin: 0 0 15px 0; color: #ffcc00;">' + (this.data.title ? removeFileExtension(this.data.title) : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') + '</h3>' +
                    '<p style="margin: 0 0 20px 0; line-height: 1.5;">' + (this.data.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') + '</p>' +
                    '<button style="background: #ffcc00; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">–ó–∞–∫—Ä—ã—Ç—å</button>';
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const closeBtn = content.querySelector('button');
                const closeModal = () => {
                    document.body.removeChild(modal);
                };
                
                closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            },
            showVideoModal: function() {
                const videoUrl = this.el.getAttribute('hotspot-handler').videoUrl || this.data.videoUrl;
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–∏–¥–µ–æ
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10001; display:flex; align-items:center; justify-content:center;';
                const box = document.createElement('div');
                box.style.cssText = 'background: #111; padding: 10px; border-radius: 10px; max-width: 90vw; max-height: 90vh; display:flex; flex-direction:column; gap:8px;';
                const title = document.createElement('div');
                title.textContent = removeFileExtension(this.data.title || '–í–∏–¥–µ–æ');
                title.style.cssText = 'color:#fff; font-weight:500; padding: 4px 8px;';
                const video = document.createElement('video');
                video.controls = true;
                video.style.maxWidth = '90vw';
                video.style.maxHeight = '75vh';
                if (videoUrl) {
                    const src = document.createElement('source');
                    src.src = videoUrl;
                    video.appendChild(src);
                } else {
                    const note = document.createElement('div');
                    note.textContent = '–í–∏–¥–µ–æ URL –Ω–µ –∑–∞–¥–∞–Ω';
                    note.style.color = '#f66';
                    box.appendChild(note);
                }
                const close = document.createElement('button');
                close.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
                close.style.cssText = 'align-self:flex-end; background:#ffcc00; color:#000; border:none; border-radius:6px; padding:8px 14px; cursor:pointer;';
                close.addEventListener('click', () => document.body.removeChild(modal));
                modal.addEventListener('click', (e) => { if (e.target === modal) document.body.removeChild(modal); });
                box.appendChild(title);
                box.appendChild(video);
                box.appendChild(close);
                modal.appendChild(box);
                document.body.appendChild(modal);
            },
            onMouseEnter: function(evt) {
                const textEl = this.el.querySelector('[cyrillic-text]');
                if (textEl) {
                    textEl.setAttribute('visible', true);
                }
                this.el.setAttribute('scale', '1.2 1.2 1.2');
                // 2D –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤–æ–∑–ª–µ –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–µ–∫
                if ((this.data.type === 'info-point' || this.data.type === 'infopoint') && this.data.title) {
                    const tip = document.createElement('div');
                    tip.className = 'tour-tooltip';
                    tip.textContent = removeFileExtension(this.data.title);
                    document.body.appendChild(tip);
                    const move = (e) => {
                        tip.style.left = (e.clientX + 12) + 'px';
                        tip.style.top = (e.clientY + 12) + 'px';
                    };
                    move(evt.detail?.cursorEl ? { clientX: window.innerWidth/2, clientY: window.innerHeight/2 } : { clientX: window.innerWidth/2, clientY: window.innerHeight/2 });
                    window.addEventListener('mousemove', move);
                    this._tooltipEl = tip;
                    this._tooltipMove = move;
                }
            },
            onMouseLeave: function() {
                const textEl = this.el.querySelector('[cyrillic-text]');
                if (textEl) {
                    textEl.setAttribute('visible', false);
                }
                this.el.setAttribute('scale', '1 1 1');
                if (this._tooltipEl) {
                    window.removeEventListener('mousemove', this._tooltipMove);
                    document.body.removeChild(this._tooltipEl);
                    this._tooltipEl = null;
                    this._tooltipMove = null;
                }
            }
        });
        

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É—Ä–∞
        window.addEventListener('DOMContentLoaded', () => {
            new TourViewer(TOUR_DATA);
        });
    </script>
</body>
</html>